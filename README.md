# ポイント分割購入プランナー

ポイント（1pt = 1円）を活用しながら同じ商品を複数回に分けて購入するとき、**現金支払い総額を最小化**する購入計画を求めるツールです。

ポイント付与率・税込単価・ポイント付与の最低注文金額などの条件を考慮し、各回の注文数・ポイント使用額・現金支払い額・獲得ポイント・残高を計算します。

---

## Web アプリ（推奨）

Next.js 製のブラウザ UI です。フォームに入力して「計算」ボタンを押すだけで最適プランを表示します。

### 起動方法

```bat
run_app.bat
```

または直接:

```bash
cd web
npm run dev
```

ブラウザで http://localhost:3000 を開いてください。

### 主な機能

| 機能 | 説明 |
|------|------|
| **合計枚数から計算** | 最終的に欲しい枚数を入力して最初から計画を立てる |
| **追加購入** | すでに何枚か持っている場合に追加分だけを計算する（購入済み枚数・保有ポイントを指定可） |
| **所持ポイント自動計算** | 追加購入タブで購入済み枚数を入力すると所持ポイントを自動計算してフィル |
| **URLシェア** | 計算条件をURLに埋め込んでコピー・共有できる |

### 入力パラメータ

| パラメータ | 説明 | 既定値 |
|------------|------|--------|
| 税込単価 | 1個あたりの税込価格（円） | 1,800 |
| 消費税率 | % | 10 |
| ポイント付与率 | % | 20 |
| ポイント付与下限 | この金額以上の注文のみポイント付与（円） | 10,000 |
| 最適化目標 | 現金最小→残高最小 / 現金最小→注文回数最小 | 現金最小→注文回数最小 |

---

## Python CLI（参照実装）

コマンドラインからも同じ最適化が実行できます。

```bash
python point_planner.py N
```

例:

```bash
python point_planner.py 12 --unit 1800 --tax 10 --rate 20 --min 10000 --basis order_total
```

### 引数

| 引数 | 説明 | 既定値 |
|------|------|--------|
| `N` | 購入する個数 | （必須） |
| `--unit` | 1個あたり税込価格（円） | `1800` |
| `--tax` | 消費税率（%） | `10` |
| `--rate` | ポイント付与率（%） | `20` |
| `--min` | ポイント付与の最低注文金額（円） | `10000` |
| `--basis` | 最低金額の判定基準（`order_total` / `cash`） | `order_total` |

---

## アルゴリズム概要

状態空間は「購入済み個数 × ポイント残高」の2次元で、層ごとに動的計画法（DP）で探索します。

- **パレートフロンティア枝刈り**: 同じ購入済み個数において「ポイント残高が少ないのに現金支払いが多い」状態を破棄し、状態数を抑制
- **候補限定**: 注文数はポイント付与閾値の前後・端点など有望な値に絞って列挙
- **注文統合**: 連続するポイント未使用かつ付与対象の注文を後処理で1注文にまとめて出力を簡潔化
- **適応的量子化**: N>70 のとき、ポイント残高を `Q = ceil(N²×P / 550,000)` 単位に切り捨て丸めしてフロンティア状態数を抑制。現金誤差は ±Q 円以内（N=100 で ±33 円 / 総額 18 万円）
- **タイムアウト保護**: 8秒を超えた場合は打ち切り（Web APIは503を返す）
- **N上限**: 500（Web API）

### N 別の性能目安（P=1,800、デフォルトパラメータ）

| N | 量子化 Q | 推定所要時間 | 精度 |
|---|---|---|---|
| ≤70 | 1（精密） | ~7秒以内 | 最適解 |
| 100 | 33 | ~5秒 | 最適解との差 ±33 円以内 |
| 200 | 131 | ~6秒 | ±131 円以内 |
| 500 | 819 | ~6秒 | ±819 円以内 |

---

## 注意事項

- ポイント付与額は `現金支払額 × 付与率 / (1 + 税率)` を切り捨てで計算します。
- ポイントは同一注文内では増えず、次回以降に使える前提です。
- 結果は丸め方や判定基準の設定に依存します。店舗・サービス固有の仕様がある場合はコードを調整してください。
